<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Chat Flow - 500 Error</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc3545;
            text-align: center;
        }
        .status-box {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button.danger { background: #dc3545; }
        .test-button.danger:hover { background: #c82333; }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .response-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat Flow Debug - 500 Error Analysis</h1>
        
        <div class="status-box success">
            <h3>‚úÖ What's Working</h3>
            <ul>
                <li><strong>Chat Session Creation</strong>: Successfully created chat_id: <code>chat_cd662f7e266a3e699a3e64ee11d</code></li>
                <li><strong>Webhook Connection</strong>: Your webhook is responding</li>
                <li><strong>Project ID</strong>: ZWQ4VZV is being accepted</li>
            </ul>
        </div>

        <div class="status-box error">
            <h3>‚ùå What's Failing</h3>
            <ul>
                <li><strong>Message Sending</strong>: 500 Internal Server Error when sending chat messages</li>
                <li><strong>Root Cause</strong>: Your webhook doesn't handle the "send_message" action yet</li>
            </ul>
        </div>

        <div class="status-box warning">
            <h3>üîß Quick Fix Needed</h3>
            <p>Your Make.com webhook needs to be updated to handle both chat actions:</p>
            <ol>
                <li><strong>create_session</strong> (‚úÖ Working)</li>
                <li><strong>send_message</strong> (‚ùå Missing - causing 500 error)</li>
            </ol>
        </div>

        <div class="form-group">
            <label for="webhookUrl">Your Webhook URL:</label>
            <input type="url" id="webhookUrl" value="https://hook.us2.make.com/8inld3fbsnclj96ucur12awsbyjmsxb5">
        </div>

        <div class="status-box info">
            <h3>üß™ Test Individual Requests</h3>
            <p>Let's test exactly what your webhook is receiving:</p>
            
            <h4>Test 1: Session Creation (Should Work)</h4>
            <div class="code-block">
{
  "project_id": "ZWQ4VZV",
  "mode": "chat",
  "action": "create_session"
}
            </div>
            <button class="test-button" onclick="testSessionCreation()">Test Session Creation</button>
            <div id="sessionResult" class="response-box" style="display: none;"></div>

            <h4>Test 2: Message Sending (Currently Failing)</h4>
            <div class="code-block">
{
  "project_id": "ZWQ4VZV",
  "mode": "chat", 
  "action": "send_message",
  "chat_id": "chat_cd662f7e266a3e699a3e64ee11d",
  "message": "test message"
}
            </div>
            <button class="test-button danger" onclick="testMessageSending()">Test Message Sending</button>
            <div id="messageResult" class="response-box" style="display: none;"></div>
        </div>

        <div class="status-box warning">
            <h3>üìã Make.com Webhook Update Checklist</h3>
            <p>Your webhook currently handles:</p>
            <ul>
                <li>‚úÖ <code>mode = "voice"</code> ‚Üí Create Web Call</li>
                <li>‚úÖ <code>mode = "chat" AND action = "create_session"</code> ‚Üí Create Chat</li>
                <li>‚ùå <code>mode = "chat" AND action = "send_message"</code> ‚Üí Create Chat Completion</li>
            </ul>

            <h4>Missing Route Configuration:</h4>
            <div class="code-block">
Route Filter: mode = "chat" AND action = "send_message"

HTTP Module:
- URL: https://api.retellai.com/create-chat-completion
- Method: POST
- Headers:
  Authorization: Bearer YOUR_RETELL_API_KEY
  Content-Type: application/json
- Body:
  {
    "chat_id": "{{webhook.chat_id}}",
    "content": "{{webhook.message}}"
  }

Response Format:
{
  "messages": {{retell_response.messages}},
  "mode": "chat",
  "action": "message_sent"
}
            </div>
        </div>

        <div class="status-box info">
            <h3>üöÄ Quick Temporary Fix</h3>
            <p>While you update your webhook, you can test the widget in demo mode by temporarily changing your project ID to include "demo":</p>
            <div class="code-block">
// Change this temporarily:
data-project-id="ZWQ4VZV"

// To this for demo mode:
data-project-id="ZWQ4VZV-demo"
            </div>
            <p>This will make the chat work in demo mode while you fix the webhook.</p>
        </div>

        <div class="status-box success">
            <h3>‚ú® Expected Behavior After Fix</h3>
            <p>Once you add the missing route, the chat flow will be:</p>
            <ol>
                <li>User types message ‚Üí Widget calls webhook with "create_session"</li>
                <li>Webhook returns chat_id ‚Üí Widget stores it</li>
                <li>User sends message ‚Üí Widget calls webhook with "send_message" + chat_id</li>
                <li>Webhook calls Retell chat completion ‚Üí Returns AI response</li>
                <li>Widget displays AI response ‚Üí Chat works perfectly!</li>
            </ol>
        </div>
    </div>

    <script>
        async function testRequest(payload, description, resultElementId) {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const resultElement = document.getElementById(resultElementId);
            
            resultElement.style.display = 'block';
            resultElement.textContent = `Testing ${description}...`;

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { raw_response: responseText };
                }

                const statusText = response.ok ? 'SUCCESS' : 'ERROR';
                const details = response.ok ? 
                    JSON.stringify(responseData, null, 2) : 
                    `Status: ${response.status} ${response.statusText}\nResponse: ${responseText}`;
                
                resultElement.textContent = `${statusText} - ${description}\n\nStatus: ${response.status}\n\nResponse:\n${details}`;

            } catch (error) {
                resultElement.textContent = `NETWORK ERROR - ${description}\n\nError: ${error.message}`;
            }
        }

        function testSessionCreation() {
            const payload = {
                project_id: "ZWQ4VZV",
                mode: "chat",
                action: "create_session"
            };
            testRequest(payload, 'Session Creation', 'sessionResult');
        }

        function testMessageSending() {
            const payload = {
                project_id: "ZWQ4VZV",
                mode: "chat",
                action: "send_message",
                chat_id: "chat_cd662f7e266a3e699a3e64ee11d",
                message: "test message"
            };
            testRequest(payload, 'Message Sending', 'messageResult');
        }
    </script>
</body>
</html>