<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Debugger - 500 Error Analysis</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc3545;
            text-align: center;
        }
        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .debug-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .response-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .checklist {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .checklist h3 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Webhook 500 Error Debugger</h1>
        
        <div class="error-box">
            <h3>‚ùå Current Issue: HTTP 500 Internal Server Error</h3>
            <p>Your webhook URL is reachable, but the Make.com scenario is failing internally. This usually means:</p>
            <ul>
                <li>Missing or incorrect Retell API key in Make.com</li>
                <li>Wrong API endpoint configuration</li>
                <li>Invalid agent ID format</li>
                <li>Missing required fields in the API call</li>
            </ul>
        </div>

        <div class="debug-section">
            <h3>üîß Debug Your Webhook</h3>
            <div class="form-group">
                <label for="webhookUrl">Your Webhook URL:</label>
                <input type="url" id="webhookUrl" value="https://hook.us2.make.com/8inld3fbsnclj96ucur12awsbyjmsxb5" placeholder="Enter your webhook URL">
            </div>
            
            <div class="form-group">
                <label for="voiceAgentId">Voice Agent ID:</label>
                <input type="text" id="voiceAgentId" value="agent_voice_demo" placeholder="Enter your voice agent ID">
            </div>
            
            <div class="form-group">
                <label for="chatAgentId">Chat Agent ID:</label>
                <input type="text" id="chatAgentId" value="agent_chat_demo" placeholder="Enter your chat agent ID">
            </div>

            <button class="test-button" onclick="testVoiceWebhook()">üé§ Test Voice Webhook</button>
            <button class="test-button" onclick="testChatWebhook()">üí¨ Test Chat Webhook</button>
            <button class="test-button" onclick="testBasicWebhook()">üîç Test Basic Connection</button>
        </div>

        <div id="results"></div>

        <div class="checklist">
            <h3>üìã Make.com Scenario Checklist</h3>
            <p>Check these items in your Make.com scenario:</p>
            
            <h4>1. Webhook Module Configuration:</h4>
            <ul>
                <li>‚úÖ Webhook is set to accept JSON data</li>
                <li>‚úÖ No authentication required (or properly configured)</li>
                <li>‚úÖ Webhook URL matches exactly</li>
            </ul>

            <h4>2. Router Configuration:</h4>
            <ul>
                <li>‚úÖ Router has two routes: voice and chat</li>
                <li>‚úÖ Voice route filter: <code>mode = "voice" OR mode is empty</code></li>
                <li>‚úÖ Chat route filter: <code>mode = "chat"</code></li>
            </ul>

            <h4>3. Retell API Configuration:</h4>
            <ul>
                <li>‚úÖ <strong>Voice Route:</strong> POST to <code>https://api.retellai.com/v2/create-web-call</code></li>
                <li>‚úÖ <strong>Chat Route:</strong> POST to <code>https://api.retellai.com/v2/create-chat</code></li>
                <li>‚úÖ Authorization header: <code>Bearer YOUR_RETELL_API_KEY</code></li>
                <li>‚úÖ Content-Type: <code>application/json</code></li>
            </ul>

            <h4>4. Request Body Format:</h4>
            <p><strong>Voice Route Body:</strong></p>
            <pre>{
  "agent_id": "{{webhook.agent_id}}",
  "retell_llm_dynamic_variables": {{webhook.dynamic_variables}}
}</pre>

            <p><strong>Chat Route Body:</strong></p>
            <pre>{
  "agent_id": "{{webhook.agent_id}}",
  "retell_llm_dynamic_variables": {{webhook.dynamic_variables}}
}</pre>

            <h4>5. Response Format:</h4>
            <ul>
                <li>‚úÖ <strong>Voice:</strong> Return <code>{"access_token": "{{retell_response.access_token}}"}</code></li>
                <li>‚úÖ <strong>Chat:</strong> Return <code>{"chat_id": "{{retell_response.chat_id}}", "mode": "chat"}</code></li>
            </ul>
        </div>

        <div class="debug-section">
            <h3>üîç Common 500 Error Causes</h3>
            
            <h4>1. Invalid Retell API Key</h4>
            <p>Check that your API key in Make.com is correct and has the right permissions.</p>
            
            <h4>2. Wrong Agent ID Format</h4>
            <p>Agent IDs should start with "agent_" followed by alphanumeric characters.</p>
            
            <h4>3. Missing Dynamic Variables</h4>
            <p>If dynamic_variables is empty or null, it might cause issues. Try using <code>{}</code> instead.</p>
            
            <h4>4. API Endpoint Typos</h4>
            <p>Double-check the Retell API URLs are exactly correct.</p>
            
            <h4>5. JSON Parsing Issues</h4>
            <p>Make sure the webhook body is properly formatted JSON.</p>
        </div>

        <div class="debug-section">
            <h3>üõ†Ô∏è Quick Fixes to Try</h3>
            
            <h4>Option 1: Simplify the Scenario</h4>
            <p>Temporarily remove the router and test with just voice calls:</p>
            <ol>
                <li>Disable the router module</li>
                <li>Connect webhook directly to Retell create-web-call</li>
                <li>Test if this works</li>
                <li>Then add back the router</li>
            </ol>

            <h4>Option 2: Check Make.com Execution Log</h4>
            <ol>
                <li>Go to your Make.com scenario</li>
                <li>Click on "History" or "Executions"</li>
                <li>Look at the failed execution</li>
                <li>Check which module is failing and why</li>
            </ol>

            <h4>Option 3: Test API Key Separately</h4>
            <p>Test your Retell API key with a simple curl command:</p>
            <pre>curl -X POST "https://api.retellai.com/v2/create-web-call" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"agent_id": "your_agent_id"}'</pre>
        </div>
    </div>

    <script>
        async function makeTestRequest(payload, description) {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const resultsDiv = document.getElementById('results');
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'response-box warning';
            loadingDiv.textContent = `Testing ${description}...`;
            resultsDiv.appendChild(loadingDiv);

            try {
                console.log(`Testing ${description}:`, payload);
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { raw_response: responseText };
                }

                // Remove loading indicator
                resultsDiv.removeChild(loadingDiv);

                // Add result
                const resultDiv = document.createElement('div');
                resultDiv.className = `response-box ${response.ok ? 'success' : 'error'}`;
                
                const statusText = response.ok ? '‚úÖ SUCCESS' : '‚ùå ERROR';
                const details = response.ok ? 
                    JSON.stringify(responseData, null, 2) : 
                    `Status: ${response.status} ${response.statusText}\nResponse: ${responseText}`;
                
                resultDiv.innerHTML = `<h4>${statusText} - ${description}</h4><pre>${details}</pre>`;
                resultsDiv.appendChild(resultDiv);

                return { success: response.ok, status: response.status, data: responseData };

            } catch (error) {
                // Remove loading indicator
                resultsDiv.removeChild(loadingDiv);
                
                // Add error result
                const errorDiv = document.createElement('div');
                errorDiv.className = 'response-box error';
                errorDiv.innerHTML = `<h4>‚ùå NETWORK ERROR - ${description}</h4><pre>${error.message}</pre>`;
                resultsDiv.appendChild(errorDiv);
                
                return { success: false, error: error.message };
            }
        }

        async function testVoiceWebhook() {
            const voiceAgentId = document.getElementById('voiceAgentId').value;
            const payload = {
                agent_id: voiceAgentId,
                mode: "voice",
                dynamic_variables: {
                    company_name: "Test Company",
                    test_mode: true
                }
            };
            
            await makeTestRequest(payload, 'Voice Webhook');
        }

        async function testChatWebhook() {
            const chatAgentId = document.getElementById('chatAgentId').value;
            const payload = {
                agent_id: chatAgentId,
                mode: "chat",
                dynamic_variables: {
                    company_name: "Test Company",
                    test_mode: true
                }
            };
            
            await makeTestRequest(payload, 'Chat Webhook');
        }

        async function testBasicWebhook() {
            const payload = {
                test: "basic_connection",
                timestamp: new Date().toISOString()
            };
            
            await makeTestRequest(payload, 'Basic Connection');
        }

        // Clear results when URL changes
        document.getElementById('webhookUrl').addEventListener('input', () => {
            document.getElementById('results').innerHTML = '';
        });
    </script>
</body>
</html>